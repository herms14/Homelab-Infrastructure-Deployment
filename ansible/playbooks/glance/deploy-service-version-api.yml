---
# Deploy Service Version Manager API for Glance Dashboard
# Tracks Docker container health, versions, and provides one-click updates.
#
# Usage:
#   ansible-playbook -i inventory.ini glance/deploy-service-version-api.yml
#
# API Endpoints:
#   - /api/services            - All services grouped by category
#   - /api/services/<category> - Services by category
#   - /api/summary             - Summary counts for sidebar widget
#   - /api/update/<name>       - Trigger service update (POST, requires X-API-Key)
#   - /api/update-status/<id>  - Poll update task progress
#   - /health                  - Health check
#   - /refresh                 - Force cache refresh

- name: Deploy Service Version Manager API
  hosts: docker-vm-core-utilities01
  become: yes
  vars:
    api_path: /opt/service-version-api
    api_port: 5070
    update_api_key: "{{ lookup('env', 'SVM_API_KEY') | default('svm-homelab-secret', true) }}"

  tasks:
    - name: Create API directory
      file:
        path: "{{ api_path }}"
        state: directory
        owner: hermes-admin
        group: hermes-admin
        mode: '0755'

    - name: Copy Python API script
      copy:
        src: files/service-version-api.py
        dest: "{{ api_path }}/app.py"
        mode: '0755'

    - name: Create requirements.txt
      copy:
        dest: "{{ api_path }}/requirements.txt"
        content: |
          flask>=3.0.0
          flask-cors>=4.0.0
          gunicorn>=21.0.0
          requests>=2.31.0
        mode: '0644'

    - name: Create Dockerfile
      copy:
        dest: "{{ api_path }}/Dockerfile"
        content: |
          FROM python:3.11-slim

          WORKDIR /app

          # Install SSH client for remote Docker host access
          RUN apt-get update && apt-get install -y openssh-client curl && rm -rf /var/lib/apt/lists/*

          RUN pip install --upgrade pip

          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt

          COPY app.py .

          EXPOSE {{ api_port }}

          CMD ["gunicorn", "-b", "0.0.0.0:{{ api_port }}", "--timeout", "120", "--workers", "2", "app:app"]
        mode: '0644'

    - name: Create Docker Compose file
      copy:
        dest: "{{ api_path }}/docker-compose.yml"
        content: |
          name: service-version-api

          services:
            service-version-api:
              build: .
              container_name: service-version-api
              restart: unless-stopped
              ports:
                - "{{ api_port }}:{{ api_port }}"
              volumes:
                - /home/hermes-admin/.ssh:/root/.ssh:ro
              environment:
                - TZ=America/New_York
                - UPDATE_API_KEY={{ update_api_key }}
              labels:
                - "com.centurylinklabs.watchtower.enable=false"
        mode: '0644'

    - name: Build and deploy container
      community.docker.docker_compose_v2:
        project_src: "{{ api_path }}"
        build: always
        state: present

    - name: Wait for API to be ready
      uri:
        url: "http://localhost:{{ api_port }}/health"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 15
      delay: 5

    - name: Verify services endpoint
      uri:
        url: "http://localhost:{{ api_port }}/api/summary"
        return_content: yes
      register: summary_result

    - name: Display deployment info
      debug:
        msg: |
          Service Version Manager API deployed successfully!

          API Endpoints:
            - All Services:   http://192.168.40.13:{{ api_port }}/api/services
            - By Category:    http://192.168.40.13:{{ api_port }}/api/services/<category>
            - Summary:        http://192.168.40.13:{{ api_port }}/api/summary
            - Update Service: POST http://192.168.40.13:{{ api_port }}/api/update/<name>
            - Update Status:  http://192.168.40.13:{{ api_port }}/api/update-status/<task_id>
            - Health:         http://192.168.40.13:{{ api_port }}/health
            - Force Refresh:  http://192.168.40.13:{{ api_port }}/refresh

          Categories: infrastructure, auth, core_apps, media, monitoring, apis_bots

          Summary: {{ summary_result.json | to_nice_json }}

          Test with:
            curl http://192.168.40.13:{{ api_port }}/api/services
            curl http://192.168.40.13:{{ api_port }}/api/summary
