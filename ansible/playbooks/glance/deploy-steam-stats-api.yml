---
# Steam Stats API Deployment
# Deploys a Flask API that fetches Steam profile data
#
# Features:
# - Recently played games with thumbnails and playtime
# - Total games owned count
# - Wishlist sale notifications (via Steam Store API)
# - Caches data to avoid rate limiting
#
# Prerequisites:
# - Steam API Key from https://steamcommunity.com/dev/apikey
# - Steam64 ID (17-digit number)
#
# Usage:
#   ansible-playbook glance/deploy-steam-stats-api.yml -e "steam_api_key=YOUR_KEY steam_id=YOUR_STEAM64_ID"

- name: Deploy Steam Stats API
  hosts: docker-vm-core-utilities01
  become: yes
  vars:
    steam_stats_path: /opt/steam-stats
    steam_stats_port: 5055
    # These should be passed via command line or vault
    steam_api_key: "{{ steam_api_key | default('YOUR_STEAM_API_KEY') }}"
    steam_id: "{{ steam_id | default('YOUR_STEAM64_ID') }}"

  tasks:
    - name: Validate Steam credentials are provided
      fail:
        msg: |
          Steam credentials not configured!

          Run with: ansible-playbook glance/deploy-steam-stats-api.yml \
            -e "steam_api_key=YOUR_KEY steam_id=YOUR_STEAM64_ID"

          To get these:
          1. Steam API Key: https://steamcommunity.com/dev/apikey
          2. Steam64 ID: https://steamid.io/ (enter your profile URL)
      when: steam_api_key == 'YOUR_STEAM_API_KEY' or steam_id == 'YOUR_STEAM64_ID'

    - name: Create Steam Stats directory
      file:
        path: "{{ steam_stats_path }}"
        state: directory
        mode: '0755'

    - name: Create Flask application
      copy:
        dest: "{{ steam_stats_path }}/app.py"
        mode: '0644'
        content: |
          from flask import Flask, jsonify
          import requests
          import os
          from datetime import datetime, timedelta
          from functools import lru_cache
          import time

          app = Flask(__name__)

          # Configuration from environment
          STEAM_API_KEY = os.environ.get('STEAM_API_KEY', '')
          STEAM_ID = os.environ.get('STEAM_ID', '')

          # Cache settings
          CACHE_DURATION = 300  # 5 minutes
          cache_data = {}
          cache_time = {}

          def get_cached(key, fetch_func):
              """Simple time-based cache"""
              now = time.time()
              if key in cache_data and (now - cache_time.get(key, 0)) < CACHE_DURATION:
                  return cache_data[key]
              try:
                  data = fetch_func()
                  cache_data[key] = data
                  cache_time[key] = now
                  return data
              except Exception as e:
                  # Return cached data if available, even if stale
                  if key in cache_data:
                      return cache_data[key]
                  raise e

          def fetch_recently_played():
              """Fetch recently played games from Steam API"""
              url = f"https://api.steampowered.com/IPlayerService/GetRecentlyPlayedGames/v1/"
              params = {
                  'key': STEAM_API_KEY,
                  'steamid': STEAM_ID,
                  'count': 10
              }
              response = requests.get(url, params=params, timeout=10)
              response.raise_for_status()
              return response.json().get('response', {})

          def fetch_owned_games():
              """Fetch owned games with app info for sorting by playtime"""
              url = f"https://api.steampowered.com/IPlayerService/GetOwnedGames/v1/"
              params = {
                  'key': STEAM_API_KEY,
                  'steamid': STEAM_ID,
                  'include_appinfo': 1,
                  'include_played_free_games': 1
              }
              response = requests.get(url, params=params, timeout=10)
              response.raise_for_status()
              return response.json().get('response', {})

          def fetch_player_summary():
              """Fetch player profile info"""
              url = f"https://api.steampowered.com/ISteamUser/GetPlayerSummaries/v2/"
              params = {
                  'key': STEAM_API_KEY,
                  'steamids': STEAM_ID
              }
              response = requests.get(url, params=params, timeout=10)
              response.raise_for_status()
              players = response.json().get('response', {}).get('players', [])
              return players[0] if players else {}

          def fetch_wishlist():
              """Fetch wishlist (public wishlists only)"""
              # Steam wishlist API (works for public wishlists)
              url = f"https://store.steampowered.com/wishlist/profiles/{STEAM_ID}/wishlistdata/"
              params = {'p': 0}
              try:
                  response = requests.get(url, params=params, timeout=10)
                  if response.status_code == 200:
                      return response.json()
              except:
                  pass
              return {}

          def format_playtime(minutes):
              """Format playtime in hours and minutes"""
              hours = minutes // 60
              mins = minutes % 60
              if hours > 0:
                  return f"{hours}h {mins}m"
              return f"{mins}m"

          def format_last_played(timestamp):
              """Format last played timestamp"""
              if not timestamp:
                  return "Unknown"
              dt = datetime.fromtimestamp(timestamp)
              now = datetime.now()
              diff = now - dt

              if diff.days == 0:
                  return "Today"
              elif diff.days == 1:
                  return "Yesterday"
              elif diff.days < 7:
                  return f"{diff.days} days ago"
              elif diff.days < 30:
                  weeks = diff.days // 7
                  return f"{weeks} week{'s' if weeks > 1 else ''} ago"
              else:
                  return dt.strftime("%b %d, %Y")

          @app.route('/stats')
          def stats():
              """Get Steam profile stats"""
              try:
                  # Fetch all data
                  recent = get_cached('recent', fetch_recently_played)
                  owned = get_cached('owned', fetch_owned_games)
                  profile = get_cached('profile', fetch_player_summary)
                  wishlist = get_cached('wishlist', fetch_wishlist)

                  # Process recently played games (top 3)
                  games = []
                  for game in recent.get('games', [])[:3]:
                      appid = game.get('appid')
                      games.append({
                          'name': game.get('name', 'Unknown'),
                          'appid': appid,
                          'thumbnail': f"https://cdn.cloudflare.steamstatic.com/steam/apps/{appid}/header.jpg",
                          'icon': f"https://cdn.cloudflare.steamstatic.com/steamcommunity/public/images/apps/{appid}/{game.get('img_icon_url', '')}.jpg",
                          'playtime_total': format_playtime(game.get('playtime_forever', 0)),
                          'playtime_total_minutes': game.get('playtime_forever', 0),
                          'playtime_2weeks': format_playtime(game.get('playtime_2weeks', 0)),
                          'playtime_2weeks_minutes': game.get('playtime_2weeks', 0),
                          'last_played': format_last_played(game.get('rtime_last_played', 0)),
                          'last_played_timestamp': game.get('rtime_last_played', 0)
                      })

                  # Process top 5 most played games (sorted by total playtime)
                  all_games = owned.get('games', [])
                  sorted_games = sorted(all_games, key=lambda x: x.get('playtime_forever', 0), reverse=True)
                  top_played = []
                  for game in sorted_games[:5]:
                      appid = game.get('appid')
                      playtime_mins = game.get('playtime_forever', 0)
                      top_played.append({
                          'name': game.get('name', 'Unknown'),
                          'appid': appid,
                          'thumbnail': f"https://cdn.cloudflare.steamstatic.com/steam/apps/{appid}/header.jpg",
                          'playtime': format_playtime(playtime_mins),
                          'playtime_minutes': playtime_mins,
                          'playtime_hours': round(playtime_mins / 60, 1)
                      })

                  # Process wishlist for sales
                  wishlist_on_sale = []
                  for appid, item in wishlist.items():
                      if item.get('subs'):
                          for sub in item.get('subs', []):
                              if sub.get('discount_pct', 0) > 0:
                                  wishlist_on_sale.append({
                                      'name': item.get('name', 'Unknown'),
                                      'appid': appid,
                                      'thumbnail': f"https://cdn.cloudflare.steamstatic.com/steam/apps/{appid}/header.jpg",
                                      'discount': sub.get('discount_pct', 0),
                                      'price': sub.get('price', 0) / 100,  # Convert cents to dollars
                                      'original_price': sub.get('price', 0) / 100 / (1 - sub.get('discount_pct', 0) / 100) if sub.get('discount_pct', 0) > 0 else 0
                                  })
                                  break

                  # Sort by discount percentage
                  wishlist_on_sale.sort(key=lambda x: x['discount'], reverse=True)

                  return jsonify({
                      'profile': {
                          'name': profile.get('personaname', 'Unknown'),
                          'avatar': profile.get('avatarfull', ''),
                          'profile_url': profile.get('profileurl', ''),
                          'status': 'Online' if profile.get('personastate', 0) == 1 else 'Offline'
                      },
                      'total_games': owned.get('game_count', 0),
                      'recent_games': games,
                      'top_played': top_played,
                      'wishlist_on_sale': wishlist_on_sale[:5],  # Top 5 sales
                      'wishlist_sale_count': len(wishlist_on_sale),
                      'total_playtime_2weeks': format_playtime(recent.get('total_count', 0)),
                      'cache_updated': datetime.now().isoformat()
                  })
              except Exception as e:
                  return jsonify({
                      'error': str(e),
                      'profile': {'name': 'Error', 'status': 'Unknown'},
                      'total_games': 0,
                      'recent_games': [],
                      'top_played': [],
                      'wishlist_on_sale': [],
                      'wishlist_sale_count': 0
                  }), 500

          @app.route('/health')
          def health():
              return jsonify({"status": "healthy", "steam_id": STEAM_ID[:4] + "..." if STEAM_ID else "not configured"})

          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=5054)

    - name: Create Dockerfile
      copy:
        dest: "{{ steam_stats_path }}/Dockerfile"
        mode: '0644'
        content: |
          FROM python:3.11-slim
          WORKDIR /app
          RUN pip install --no-cache-dir flask gunicorn requests
          COPY app.py .
          EXPOSE 5055
          CMD ["gunicorn", "-w", "2", "-b", "0.0.0.0:5055", "app:app"]

    - name: Create Docker Compose file
      copy:
        dest: "{{ steam_stats_path }}/docker-compose.yml"
        mode: '0644'
        content: |
          services:
            steam-stats:
              build: .
              container_name: steam-stats
              restart: unless-stopped
              ports:
                - "5055:5055"
              environment:
                - TZ=Asia/Manila
                - STEAM_API_KEY={{ steam_api_key }}
                - STEAM_ID={{ steam_id }}
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:5055/health"]
                interval: 30s
                timeout: 10s
                retries: 3

    - name: Build and deploy Steam Stats container
      community.docker.docker_compose_v2:
        project_src: "{{ steam_stats_path }}"
        state: present
        build: always

    - name: Wait for Steam Stats API to be ready
      uri:
        url: "http://localhost:{{ steam_stats_port }}/health"
        status_code: [200]
      register: api_status
      until: api_status.status == 200
      retries: 30
      delay: 2

    - name: Test API response
      uri:
        url: "http://localhost:{{ steam_stats_port }}/stats"
        return_content: yes
      register: stats_response
      ignore_errors: yes

    - name: Display deployment information
      debug:
        msg: |
          ===========================================
          Steam Stats API Deployed Successfully!
          ===========================================

          API Endpoint: http://192.168.40.10:{{ steam_stats_port }}/stats
          Health Check: http://192.168.40.10:{{ steam_stats_port }}/health

          Steam Profile: {{ stats_response.json.profile.name | default('N/A') }}
          Total Games: {{ stats_response.json.total_games | default('N/A') }}
          Wishlist Sales: {{ stats_response.json.wishlist_sale_count | default('N/A') }} items

          Files:
          ------
          Flask App: {{ steam_stats_path }}/app.py
          Dockerfile: {{ steam_stats_path }}/Dockerfile
          Docker Compose: {{ steam_stats_path }}/docker-compose.yml

          To rebuild after changes:
          cd {{ steam_stats_path }} && docker compose up -d --build
