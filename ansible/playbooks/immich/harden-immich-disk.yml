---
# Harden Immich Host Disk Management + Deploy node_exporter
# Addresses disk-full incident that crashed Immich via Redis RDB failures
#
# Targets: immich-vm01 (192.168.40.22)
#
# What this does:
#   1. Configures Docker daemon log rotation (10MB max, 3 files)
#   2. Limits systemd journal to 100MB
#   3. Deploys node_exporter via Docker (port 9100)
#   4. Runs cleanup to reclaim disk space
#
# Usage:
#   ansible-playbook immich/harden-immich-disk.yml -i "192.168.40.22," -u hermes-admin --become
#
# Prerequisites:
#   - SSH access to 192.168.40.22 as hermes-admin
#   - Docker installed on target host

- name: Harden Immich Host Disk Management + Deploy node_exporter
  hosts: all
  become: true
  gather_facts: true
  vars:
    immich_host: "192.168.40.22"
    node_exporter_version: "latest"
    node_exporter_port: 9100
    docker_log_max_size: "10m"
    docker_log_max_file: "3"
    journal_max_size: "100M"

  tasks:
    # =========================================================================
    # Phase 1: Docker Daemon Log Rotation
    # =========================================================================
    - name: "Phase 1 - Docker log rotation"
      block:
        - name: Create Docker daemon.json for log rotation
          copy:
            dest: /etc/docker/daemon.json
            content: |
              {
                "log-driver": "json-file",
                "log-opts": {
                  "max-size": "{{ docker_log_max_size }}",
                  "max-file": "{{ docker_log_max_file }}"
                }
              }
            owner: root
            group: root
            mode: "0644"
            backup: true
          register: docker_daemon_config

        - name: Restart Docker to apply log rotation
          systemd:
            name: docker
            state: restarted
          when: docker_daemon_config.changed

        - name: Verify Docker log config
          command: docker info --format '{{ "{{" }}.LoggingDriver{{ "}}" }}'
          register: docker_log_driver
          changed_when: false

        - name: Display Docker log driver
          debug:
            msg: "Docker logging driver: {{ docker_log_driver.stdout }}"

    # =========================================================================
    # Phase 2: Systemd Journal Size Limit
    # =========================================================================
    - name: "Phase 2 - Journal size limits"
      block:
        - name: Create journald config directory
          file:
            path: /etc/systemd/journald.conf.d
            state: directory
            owner: root
            group: root
            mode: "0755"

        - name: Configure journal size limit
          copy:
            dest: /etc/systemd/journald.conf.d/size-limit.conf
            content: |
              [Journal]
              SystemMaxUse={{ journal_max_size }}
              SystemKeepFree=500M
              MaxRetentionSec=1week
            owner: root
            group: root
            mode: "0644"
          register: journal_config

        - name: Restart journald to apply limits
          systemd:
            name: systemd-journald
            state: restarted
          when: journal_config.changed

    # =========================================================================
    # Phase 3: Deploy node_exporter
    # =========================================================================
    - name: "Phase 3 - Deploy node_exporter"
      block:
        - name: Create node_exporter directory
          file:
            path: /opt/node-exporter
            state: directory
            owner: root
            group: root
            mode: "0755"

        - name: Deploy node_exporter docker-compose.yml
          copy:
            dest: /opt/node-exporter/docker-compose.yml
            content: |
              services:
                node-exporter:
                  image: prom/node-exporter:{{ node_exporter_version }}
                  container_name: node-exporter
                  restart: unless-stopped
                  ports:
                    - "{{ node_exporter_port }}:9100"
                  volumes:
                    - /proc:/host/proc:ro
                    - /sys:/host/sys:ro
                    - /:/rootfs:ro
                  command:
                    - '--path.procfs=/host/proc'
                    - '--path.sysfs=/host/sys'
                    - '--path.rootfs=/rootfs'
                    - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
                  logging:
                    driver: json-file
                    options:
                      max-size: "5m"
                      max-file: "2"
                  network_mode: host
            owner: root
            group: root
            mode: "0644"

        - name: Start node_exporter container
          command: docker compose up -d
          args:
            chdir: /opt/node-exporter

        - name: Wait for node_exporter to be ready
          uri:
            url: "http://localhost:{{ node_exporter_port }}/metrics"
            method: GET
            status_code: 200
          register: node_exporter_check
          retries: 5
          delay: 3
          until: node_exporter_check.status == 200

        - name: Verify node_exporter filesystem metrics
          command: "curl -s http://localhost:{{ node_exporter_port }}/metrics"
          register: node_exporter_metrics
          changed_when: false

        - name: Confirm filesystem metrics are available
          assert:
            that:
              - "'node_filesystem_avail_bytes' in node_exporter_metrics.stdout"
            fail_msg: "node_exporter is not reporting filesystem metrics!"
            success_msg: "node_exporter is reporting filesystem metrics correctly"

    # =========================================================================
    # Phase 4: Disk Cleanup
    # =========================================================================
    - name: "Phase 4 - Disk cleanup"
      block:
        - name: Get disk usage before cleanup
          command: df -h /
          register: disk_before
          changed_when: false

        - name: Display disk usage before cleanup
          debug:
            msg: "{{ disk_before.stdout_lines }}"

        - name: Prune unused Docker resources
          command: docker system prune -f
          register: docker_prune

        - name: Display Docker prune results
          debug:
            msg: "{{ docker_prune.stdout }}"

        - name: Vacuum journal logs to limit
          command: "journalctl --vacuum-size={{ journal_max_size }}"
          register: journal_vacuum

        - name: Display journal vacuum results
          debug:
            msg: "{{ journal_vacuum.stdout }}"

        - name: Get disk usage after cleanup
          command: df -h /
          register: disk_after
          changed_when: false

        - name: Display disk usage after cleanup
          debug:
            msg: "{{ disk_after.stdout_lines }}"

    # =========================================================================
    # Summary
    # =========================================================================
    - name: Display summary
      debug:
        msg:
          - "=========================================="
          - "  Immich Host Hardening Complete"
          - "=========================================="
          - ""
          - "Docker log rotation: {{ docker_log_max_size }} max, {{ docker_log_max_file }} files"
          - "Journal limit: {{ journal_max_size }}"
          - "node_exporter: http://{{ immich_host }}:{{ node_exporter_port }}/metrics"
          - ""
          - "Next steps:"
          - "  1. Add Prometheus scrape target for {{ immich_host }}:{{ node_exporter_port }}"
          - "  2. Deploy Grafana dashboard (immich-host-health)"
          - "  3. Configure Grafana alerts for disk thresholds"
